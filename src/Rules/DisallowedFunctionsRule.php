<?php

declare(strict_types=1);

namespace PlentymarketsRules\Rules;

use PhpParser\Node;
use PHPStan\Rules\Rule;
use PHPStan\Analyser\Scope;

/**
 * @implements Rule<Node\Expr\FuncCall>
 */
class DisallowedFunctionsRule implements Rule
{
    private $allowedFunctions = [
        'pluginApp',
        'addcslashes',
        'addslashes',
        'array',
        'array_change_key_case',
        'array_chunk',
        'array_column',
        'array_combine',
        'array_count_values',
        'array_diff',
        'array_diff_assoc',
        'array_diff_key',
        'array_diff_uassoc',
        'array_diff_ukey',
        'array_fill',
        'array_fill_keys',
        'array_filter',
        'array_flip',
        'array_intersect',
        'array_intersect_assoc',
        'array_intersect_key',
        'array_intersect_uassoc',
        'array_intersect_ukey',
        'array_key_exists',
        'array_key_first',
        'array_key_last',
        'array_keys',
        'array_map',
        'array_merge',
        'array_merge_recursive',
        'array_multisort',
        'array_pad',
        'array_pop',
        'array_product',
        'array_push',
        'array_rand',
        'array_reduce',
        'array_replace',
        'array_replace_recursive',
        'array_reverse',
        'array_search',
        'array_shift',
        'array_slice',
        'array_splice',
        'array_sum',
        'array_udiff',
        'array_udiff_assoc',
        'array_udiff_uassoc',
        'array_uintersect',
        'array_uintersect_assoc',
        'array_uintersect_uassoc',
        'array_unique',
        'array_unshift',
        'array_values',
        'array_walk',
        'array_walk_recursive',
        'arsort',
        'asort',
        'base64_decode',
        'base64_encode',
        'basename',
        'bin2hex',
        'boolval',
        'ceil',
        'checkdate',
        'chop',
        'chr',
        'chunk_split',
        'clone',
        'compact',
        'count',
        'count_chars',
        'crypt',
        'ctype_alnum',
        'ctype_alpha',
        'curl_close',
        'curl_errno',
        'curl_error',
        'curl_exec',
        'curl_getinfo',
        'curl_init',
        'curl_multi_add_handle',
        'curl_multi_close',
        'curl_multi_exec',
        'curl_multi_getcontent',
        'curl_multi_init',
        'curl_multi_remove_handle',
        'curl_setopt',
        'curl_setopt_array',
        'current',
        'date',
        'date_add',
        'date_create',
        'date_create_from_format',
        'date_diff',
        'date_modify',
        'date_sub',
        'each',
        'easter_date',
        'easter_days',
        'elseif',
        'end',
        'exit',
        'explode',
        'extract',
        'filter_var',
        'filter_var_array',
        'floatval',
        'floor',
        'function_exists',
        'get_class',
        'get_parent_class',
        'getdate',
        'getimagesize',
        'gmdate',
        'hash',
        'hash_hmac',
        'header',
        'hexdec',
        'html_entity_decode',
        'htmlentities',
        'htmlspecialchars',
        'http_build_query',
        'implode',
        'in_array',
        'intval',
        'invariant',
        'is_array',
        'is_bool',
        'is_float',
        'is_int',
        'is_null',
        'is_numeric',
        'is_object',
        'is_string',
        'isset',
        'json_decode',
        'json_encode',
        'key',
        'key_exists',
        'krsort',
        'ksort',
        'lcfirst',
        'levenshtein',
        'list',
        'ltrim',
        'max',
        'mb_check_encoding',
        'mb_convert_encoding',
        'mb_detect_encoding',
        'mb_strcut',
        'mb_strimwidth',
        'mb_strlen',
        'mb_substr',
        'md5',
        'microtime',
        'min',
        'mktime',
        'natcasesort',
        'natsort',
        'next',
        'nl2br',
        'number_format',
        'numfmt_create',
        'openssl_decrypt',
        'openssl_encrypt',
        'ord',
        'parse_str',
        'parse_url',
        'pathinfo',
        'pos',
        'pow',
        'preg_match',
        'preg_match_all',
        'preg_replace',
        'preg_split',
        'prev',
        'property_exists',
        'rand',
        'random_int',
        'range',
        'rawurldecode',
        'rawurlencode',
        'reset',
        'return',
        'round',
        'rsort',
        'rtrim',
        'setcookie',
        'sha1',
        'shuffle',
        'simplexml_load_string',
        'sizeof',
        'sleep',
        'sort',
        'sprintf',
        'sqrt',
        'str_contains',
        'str_getcsv',
        'str_ireplace',
        'str_pad',
        'str_replace',
        'str_split',
        'strcmp',
        'strftime',
        'strip_tags',
        'stripos',
        'stripslashes',
        'strlen',
        'strnatcmp',
        'strpos',
        'strrpos',
        'strtolower',
        'strtotime',
        'strtoupper',
        'substr',
        'substr_count',
        'switch',
        'time',
        'trim',
        'uasort',
        'ucfirst',
        'ucwords',
        'uksort',
        'uniqid',
        'unset',
        'urldecode',
        'urlencode',
        'usort',
        'utf8_decode',
        'utf8_encode',
        'wordwrap',
    ];

    public function getNodeType(): string
    {
        return Node\Expr\FuncCall::class;
    }

    public function processNode(Node $node, Scope $scope): array
    {
        $functionName = $node->name->getLast();

        if (in_array($functionName, $this->allowedFunctions)) {
            return [];
        }

        return [
            sprintf('Function "%s()" is not allowed', $functionName),
        ];
    }
}
